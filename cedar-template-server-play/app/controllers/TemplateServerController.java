package controllers;

import com.fasterxml.jackson.databind.JsonNode;
import org.metadatacenter.server.Constants;
import org.metadatacenter.server.service.FieldNameInEx;
import org.metadatacenter.server.service.TemplateService;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import play.libs.Json;
import play.mvc.Result;
import utils.JsonUtils;
import utils.LinkHeaderUtil;
import utils.Utils;

import javax.management.InstanceNotFoundException;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import static org.metadatacenter.server.Constants.HTTP_HEADER_LINK;

public class TemplateServerController extends GenericElementServerController {
  private static Logger log = LoggerFactory.getLogger(TemplateServerController.class);

  private static TemplateService<String, JsonNode> templateService;
  protected static List<String> FIELD_NAMES_SUMMARY_LIST;

  static {
    FIELD_NAMES_SUMMARY_LIST = new ArrayList<String>();
    FIELD_NAMES_SUMMARY_LIST.add("@id");
    FIELD_NAMES_SUMMARY_LIST.add("title");
    FIELD_NAMES_SUMMARY_LIST.add("properties.info.title");
    FIELD_NAMES_SUMMARY_LIST.add("properties.info.description");
  }

  public static void injectTemplateService(TemplateService<String, JsonNode> ts) {
    templateService = ts;
  }

  public static Result createTemplate() {
    log.info("Received create template request");

    try {
      JsonNode template = request().body().asJson();
      JsonNode createdTemplate = templateService.createTemplateLinkedData(template);
      // Remove autogenerated _id field to avoid exposing it
      createdTemplate = JsonUtils.removeField(createdTemplate, "_id");
      // Set Location header pointing to the newly created template
      String id = createdTemplate.get("@id").asText();
      String absoluteUrl = routes.TemplateServerController.findTemplate(id, false, false).absoluteURL(request());
      response().setHeader(Constants.HTTP_HEADER_LOCATION, absoluteUrl);
      // Return created response
      return created(createdTemplate);
    } catch (IllegalArgumentException e) {
      return badRequestWithError(e);
    } catch (Exception e) {
      return internalServerErrorWithError(e);
    }
  }

  public static Result findTemplate(String templateId, boolean expanded, boolean validation) {
    log.info("Received findTemplate request with template ID " + templateId);
    try {
      JsonNode template = templateService.findTemplateByLinkedDataId(templateId, expanded, validation);
      if (template != null) {
        // Remove autogenerated _id field to avoid exposing it
        template = JsonUtils.removeField(template, "_id");
        return ok(template);
      }
      return notFound();
    } catch (IllegalArgumentException e) {
      return badRequestWithError(e);
    } catch (Exception e) {
      return internalServerErrorWithError(e);
    }
  }

  public static Result findAllTemplates(Integer limit, Integer offset, boolean summary) {
    try {
      limit = ensureLimit(limit);
      checkPagingParameters(limit, offset);
      Map<String, Object> r = new HashMap<>();
      List<JsonNode> templates = null;
      if (summary) {
        templates = templateService.findAllTemplates(limit, offset, FIELD_NAMES_SUMMARY_LIST, FieldNameInEx.INCLUDE);
        response().setHeader("Cedar-Field-Names", Json.toJson(FIELD_NAMES_SUMMARY_LIST).toString());
      } else {
        templates = templateService.findAllTemplates(limit, offset, FIELD_NAMES_EXCLUSION_LIST, FieldNameInEx.EXCLUDE);
      }
      long total = templateService.count();
      response().setHeader(Constants.HTTP_CUSTOM_HEADER_TOTAL_COUNT, String.valueOf(total));
      checkPagingParametersAgainstTotal(offset, total);
      String absoluteUrl = routes.TemplateServerController.findAllTemplates(0, 0, false).absoluteURL(request());
      absoluteUrl = Utils.trimUrlParameters(absoluteUrl);
      String linkHeader = LinkHeaderUtil.getPagingLinkHeader(absoluteUrl, total, limit, offset);
      if (!linkHeader.isEmpty()) {
        response().setHeader(HTTP_HEADER_LINK, linkHeader);
      }
      return ok(Json.toJson(templates));
    } catch (Exception e) {
      return internalServerErrorWithError(e);
    }
  }

  public static Result updateTemplate(String templateId) {
    JsonNode modifications = request().body().asJson();
    try {
      JsonNode updatedTemplate = templateService.updateTemplateByLinkedDataId(templateId, modifications);
      // Remove autogenerated _id field to avoid exposing it
      updatedTemplate = JsonUtils.removeField(updatedTemplate, "_id");
      return ok(updatedTemplate);
    } catch (IllegalArgumentException e) {
      return badRequestWithError(e);
    } catch (InstanceNotFoundException e) {
      return notFound();
    } catch (Exception e) {
      return internalServerErrorWithError(e);
    }
  }

  public static Result deleteTemplate(String templateId) {
    try {
      templateService.deleteTemplateByLinkedDataId(templateId);
      return noContent();
    } catch (IllegalArgumentException e) {
      return badRequestWithError(e);
    } catch (InstanceNotFoundException e) {
      return notFound();
    } catch (Exception e) {
      return internalServerErrorWithError(e);
    }
  }

}
